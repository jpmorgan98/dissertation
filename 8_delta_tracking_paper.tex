\newpage
\renewcommand{\TheTitle}{Hybrid Woodcock-delta Tracking Schemes Using a Track-Length Estimator}
\renewcommand{\TheAuthors}{Joanna Piper Morgan,
  Ilham Variansyah,
  Kayla B. Clements,
  Todd S. Palmer,
  Kyle E. Niemeyer}

\renewcommand{\TheAddress}{%
In preparation for submission
}

\PaperHeader{\TheTitle}{\TheAuthors}{\TheAddress}

\chapter{\TheTitle}
\label{chap:delta_tracking_paper}

\epigraphhead[10]{\singlespacing
    \epigraph{
        I would have really liked just doing laundry and taxes with you.
    }
    {Waymond Wang---Everything Everywhere All at Once}
}

%%% Write text for abstract
%%% Most text modifying commands will work in abstract
\section*{Abstract}

In Monte Carlo radiation transport calculations, Woodcock-delta tracking is a common alternative to the more popular surface tracking technique, where the largest cross-section at a given energy in a problem is used to sample a distance to collision at any point.
Because this process forces extra nonphysical collisions, it is paired with rejection sampling to determine real events from virtual or phantom events.
Traditional implementations of Woodcock-delta tracking preclude the use of a track (or path-) length estimator for scalar flux tallies and are forced to use the normally higher-variant collision estimator instead.
No mathematical reason prohibits use of the track length estimator with Woodcock-delta tracking; however, implementation issues have made this combination very rare. 
In this work we produce a Woodcock-delta tracking algorithm that tallies fluxes to a structured rectilinear mesh using the track length estimator.
This development more readily enables hybrid surface-delta tracking algorithms, because the track length tally can be used everywhere for scalar flux estimation regardless of which tracking algorithm is employed.
We use this tallying technique when developing a novel hybrid-in-energy method, where Woodcock-delta tracking is used for high energy particles (where mean free paths are long) and surface tracking is used for resonance energies and below. 
We also implement a hybrid-in-material method, similar to what is implemented in Serpent2.
We also demonstrate that these delta tracking algorithms can be used in conjunction with continuously moving surfaces.
We compare these methods showing figures of merit on four time-dependent problems: two multi-group and two continuous-energy.
Woodcock-delta tracking with a track length tally shows modest improvements to figures of merit as compared to traditional delta tracking with a collision estimator and surface tracking with a track length estimator (\num{1.5}$\times$--\num{2.5}$\times$) for a problem with significant void regions.
For a standard PWR reactor benchmark (both multi group and continuous energy) traditional Woodcock-delta tracking (with a collision estimator) performs best.
Hybrid-in-energy methods showed significant improvements (\num{7}$\times$--\num{11}$\times$) when using used in a continuous energy reactor benchmark problem.

% general introduction
Predicting the neutron distribution in space, energy and time is important when modeling inertial confinement fusion experiments, pulsed neutron sources, and nuclear criticality safety experiments, among other systems.
The behavior of neutrons can be modeled with a Monte Carlo simulation, where particles with statistical importance are created and transported to produce a particle history \cite{lewis_computational_1984}. 
The path of a particle and the specific set of events that occur within its history are governed by pseudo-random numbers, known probabilities (e.g., from material data), and known geometries. Data about how
particles move and/or interact with the system are tallied to compute parameters of interest with an associated statistical error from the Monte Carlo process.

There are two common methods used to sample the random walk in a Monte Carlo neutron transport algorithm: surface tracking \cite{lewis_computational_1984} and Woodcock-delta tracking \cite{woodcock_techniques_1965}.
These two tracking algorithms have complementary performance bottlenecks; for a certain class of problems, a hybrid method may allow for greater performance than either approach used individually.
For example: traditional implementations of Woodcock-delta tracking preclude evaluating quantities of interest with a track length estimator, instead opting for a collision estimator, while, surface tracking has no such restrictions.
The track length estimator usually better estimates quantities of interest (see section \ref{sec:tracking_algs_and_est}).
On the other hand, surface tracking requires potentially complicated geometric operations whereas Woodcock-delta tracking does not.
Which method is more computationally efficient often problem dependent.
There are other, weighted Woodcock-delta tracking algorithms; in this work we explore variants of non-weighted version \cite{molnar_variance_2018, morgan_weighted-delta-tracking_2015}.

% cite previous M&C paper

Previous work into hybrid delta-surface tracking on a structured mesh has shown good performance for problems with complex arrangements of optically-thin materials \cite{morgan2023delta}.
Making material-based decisions about when to do delta and surface tracking has also been explored and implemented in production Monte Carlo codes \cite{leppanen_development_2013, leppanen_2010_burnup, richards_monk_2015}.
We extend the idea of \textit{tracking} on a structured mesh to full Woodcock-delta tracking (eliminating the distance to surface check) and \textit{tallying} to a structured mesh, allowing the use of a track length estimator for estimating scalar flux.
% MC/DC introduction

In this work we describe, verify, and evaluate the performance of a delta tracking algorithm that allows the use of a track length estimator on a structured tally mesh.
We then use this approach in two hybrid delta tracking schemes: one in which the choice of tracking algorithm is based on material region, and another scheme based on the particle energy.
We implement this work in Monte Carlo Dynamic Code (MC/DC), an open-source Monte Carlo neutron transport application purpose-built to conduct rapid numerical methods development, specifically for time-dependent problems \cite{morgan_monte_2024}.
We compute figures of merit for four computationally difficult benchmark problems including a stuck rod accident simulation of a continuous energy version of the C5G7 geometry, and runtime results for a whole CPU node (2$times$ Intel x86 Xeon Sapphire Rapids) and a whole GPU Node (4$\times$ Nvidia Tesla V100) of super computers from Livermore National Laboratory.

This work is novel as it is the first published use of a track length estimator for scalar flux with full Woodcock-delta tracking, the first use of Woodcock-delta tracking in conjunction with continuously moving surfaces (implemented in MC/DC \cite{variansyah_2023_highfidelity}), and the first time a hybrid delta tracking method has been based on the energy of a given particle.
The quantities of interest in this work are estimates of scalar flux and not full reaction rate densities for all particle material interactions.
While this does limit the generally applicability of these methods, scalar flux is a necessary quantity for hybrid methods, and other uses.
For deterministic methods, if scalar flux is ascertained the problem is considered solved.


\section{Tracking Algorithms and Estimators}
\label{sec:tracking_algs_and_est}

% Surface tracking
To track the movement of neutrons within a system, one of two tracking (or sampling) methods are employed. 
The first is surface tracking, described in Algorithm \ref{alg:surface}. 
For a particle in material $m$, a distance to collision is sampled from a cumulative probability distribution function by
\begin{equation}
    d_{\text{collision}} = \frac{-\ln(\xi)}{\Sigma_{t,m}(E)} \; ,
\end{equation}
where $\Sigma_{t,m}(E)$ [\SI{}{\per\centi\meter}] is the macroscopic total cross section at a given energy $E$ of the $m$ material and $\xi$ is a pseudo-random number between zero and one.

This sampling of the cumulative probability distribution function will only hold true while the material is homogeneous.
If the distance to collision is beyond a material interface in a system with multiple materials, the particle must be stopped at that interface surface and a new distance to collision must be calculated with the new material's $\Sigma_{t,m}(E)$.
This approach is an unbiased way of dealing with the sampling of distance to collision in a heterogeneous medium.
In a standard surface tracking algorithm this involves computing both a distance to collision ($d_{\text{collision}}$) and a distance to the nearest surface along the particle's direction of travel ($d_{\text{surface}}$).
The smaller of these two distances determines which event happens to the particle---a collision or a surface-crossing.
After or while the particle is moving, tallies can be accumulated to compute quantities of interest.
If a collision occurs, more sampling and associated operations can be done (e.g., isotropically scatter a particle).
If the particle is still alive at the end, the algorithm is repeated.
The distance to nearest surface computation can become quite expensive as geometries grow in complexity (e.g., complex cumulative solid geometries (CSG) or CAD-based surfaces).
Surface tracking lies at the heart of many modern Monte Carlo neutron transport applications, including MCNP \cite{MCNP_RisingArmstrongEtAl}, Shift \cite{hamilton_continuous-energy_2019, pandya_implementation_2016}, MONK/MCBEND \cite{richards_monk_2015}, and OpenMC \cite{romano_openmc_2015}.

\begin{algorithm}
\begin{algorithmic}[1]

    \State $m =$ lookup material in current particle location

    \State $\Sigma_{t,m} =$ look up total macroscopic cross section of material $m$ 

    \While{particle is alive}
    
        \State $d_{\text{collision}} = -\ln{\xi} / \Sigma_{t,m} $
        
        \State $d_{\text{surface}} =$ compute distance to nearest surface along particle direction of travel

        \If {$d_{\text{collision}} < d_{\text{surface}}$}

                \State $d = d_{\text{collision}}$
                
                \State sample collision type
                
                \State carry out collision
                
             \Else 

                \State $d = d_{\text{surface}}$
        
                \State move particle to surface
    
                \State $m =$ lookup material on the other side of the surface
    
                \State $\Sigma_{t,m} =$ look up total macroscopic cross section of material $m$ 
    
                \If {surface is a boundary}
    
                    \State implement boundary condition
    
            \EndIf
        \EndIf
        s\State core track lengths to tally bins
    \EndWhile
    
    \vspace{1.5em}
    \caption{A generic surface tracking algorithm.}
    \label{alg:surface}
\end{algorithmic}
\end{algorithm}


Delta tracking is the next most common tracking approach, shown in Algorithm \ref{alg:trad}.
It starts by pre-processing a \textit{majorant} macroscopic cross-section
\begin{equation}
    \maj(E) = \max\left({\Sigma_{t,1}(E), \Sigma_{t,2}(E) \dots \Sigma_{t,m}(E) \dots \Sigma_{t,M}(E)}\right) \; ,
\end{equation}
where $M$ is the total number of materials in the simulation, such that it is the largest cross section at any given point in any material in the problem.
The algorithm to compute the majorant cross-section for nuclides on a non-unified energy grid currently implemented in MC/DC is derived in Appendix \ref{app:majorant}.
Figure \ref{fig:majorant_c5ce} shows a macroscopic majorant cross section for a typical pressurized water reactor.
When delta tracking the distance to collision is always sampled with the majorant,
\begin{equation}
    d_{\text{collision}} = \frac{-\ln{(\xi)}}{\maj(E)} \; ,
\end{equation}
ignoring surface crossing events.
However, this sampling forces extra collisions that do not physically occur; using the majorant generates the smallest distance to collision.
Delta tracking algorithms use a rejection sample to determine if the sampled collision event was \textit{real} or a \textit{virtual} or \textit{phantom} collision.
At the particle's current location, the true material region is identified only to compute $\Sigma_{t,m}$ after a potential collision.
If 
\begin{equation}
    \xi > \frac{\Sigma_{t,m}(E)}{\maj(E)} \; ,
\end{equation}
where $\xi$ is a new random number, the collision did not physically occur, is rejected, and the particle can be left alive on its current direction of travel and energy.
From here the process is the same as before: tallies are accumulated, real collision physics are carried out when appropriate, and the algorithm continues as long as the particle is still alive.

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{figures/delta_figs/macro_majorant_c5ce.pdf}
    \caption{Continuous energy macroscopic majorant ($\maj(E)$) and other material cross-sections for the continuous energy version of C5G7 pressurized water reactor described in appendix \ref{app:c5ce_mat}.}
    \label{fig:majorant_c5ce}
\end{figure}

Delta tracking needs some way to kill or reflect particles on vacuum or reflecting boundary conditions, respectively.
In a code that already implements surface tracking, the functionality to track distances to specific surfaces will already exist.
So it is natural when undergoing delta tracking to only compare distances to boundary surfaces exclusively.
Boundary surfaces are often planar, making the computation trivial and cheap compared to full CSG geometries.
%This is similar to other methods currently under development in OpenMC.

\begin{algorithm}
\begin{algorithmic}[1]

    \While{particle is alive}
    
        \State $d_{\text{collision}} = -\ln{\xi} / \maj $
        
        \State $d_{\text{boundary}} =$ compute distance to boundary

        \If {$d_{\text{collision}} < d_{\text{boundary}}$}

            \State $m =$ lookup material in current particle location
            
            \State $\Sigma_{t} =$ look up total macroscopic cross section of material $m$ 

            \If { $\xi > \Sigma_{t} / \maj$ }

                \State collision is rejected

             \Else 
            
                \State collision is accepted

                \State tally $1/\Sigma_t$ to bin at particles current location

                \State determine collision type 
                
                \State carry out collision
                
            \EndIf
                
        \Else 
        
            \State move particle to boundary

            \State implement boundary condition
        \EndIf
        
    \EndWhile
    
    \vspace{1.5em}
    \caption{Woodcock-delta tracking in MC/DC. Notably we are still surface tracking to boundaries.}
    \label{alg:trad}
\end{algorithmic}
\end{algorithm}

An added complication when using the Woodcock-delta tracking method is restricting what type of tallies can be efficiently scored.
There are many so-called estimators that can be used to indicate quantities of interest (often scalar flux) by tallying events that occur within a given region of phase space.
Two common estimators are the collision estimator and the the path- or track length estimator \cite{lewis_computational_1984}.
Often tallies are scored to bins on a structured mesh grid overlying the surfaces and material regions that a Monte Carlo simulations uses to conduct actual transport operations.
The track length estimator is
\begin{equation}
    \label{eq:pathlength}
    \hat{\phi}_n = \sum_{i=1}^{I}p_{i,n} \; ,
\end{equation}
where $\hat{\phi}$ is the integrated scalar flux over given mesh cell $n$, $p$ is the track length of particle $i$ passing through mesh cell $n$.
The collision estimator is
\begin{equation}
    \label{eq:collision}
    \hat{\phi}_n = \sum_{i=1}^{I} \frac{1}{\Sigma_{t,n}(E)} \;.
\end{equation}
The collision estimator will often produce a more variant solution as compared to other estimators for tallies where $\Sigma_{t,m}$ is small (optically thin, less dense materials) and will never tally anything into a true void region \cite{mc2018, leppanen_use_2017}.
On the other hand the track length estimator will always tally into every mesh bin as particles move.
Meaning, for some problem regimes, more information will be scored, which will result in a lower-variant tally for the same number of particles.

Both of the estimators in Eqs. \eqref{eq:collision} and \eqref{eq:pathlength} are only for flux integrals, where response functions are one.
Response functions for other reaction rates (e.g., fission rate density) will require the knowledge of the macroscopic cross section of that operation in a given location.
In this work we limit ourselves to flux integrals only.
Thus we also only enable these schemes for fixed-source problems and leave $k$-eigenvalue calculations for future work.
This does currently limit the more general applicability of the methods we implement, though future work may extend these methods to allow computing of these parameters.
We discuss this further in Section \ref{disucssions}.

Delta tracking algorithms are implemented in many production Monte Carlo neutron transport applications including Serpent2 \cite{leppanen_2010_burnup, leppanen_use_2017, leppanen_development_2013}, MONK/MCBEND \cite{richards_monk_2015}, IMPC \cite{fang_development_2022}, and GUARDYAN \cite{molnar_gpu_based_2019}.
Notably, the MONK Monte Carlo neutron transport code is the direct successor to the GEM code where Woodcock et al.~first implemented Woodcock-delta tracking \cite{woodcock_techniques_1965}.

% what other codes do and how this work is novel
Modern transport applications often choose one tracking algorithm or the other and optimize from there.
However, either method of sampling the probability distribution functions can hold valid for the same system in the same simulation even at the same location in phase space.
The Serpent2 Monte Carlo code establishes regions of delta tracking and surface tracking based on the ratio between the ratio of $\Sigma_{t,m}$ and $\maj$ and a user supplied constant $\in [0,1]$ \cite{leppanen_development_2013}.
MONK/MCBEND support material regions inside of which delta tracking is implemented (called hole geometries) for complex materials like stochastically heterogeneous materials (e.g., aggregate and cement mixtures in concrete) or incredibly complected geometries (e.g., TRISO fuel elements) while surface tracking is used elsewhere \cite{richards_monk_2015, richards_monk_2025}.
%Ongoing developments in OpenMC and MCNP will introduce similar delta tracking algorithms for 
%Publications indicate that no other Monte Carlo neutron transport application currently supports the use of any track length estimator within a region undergoing Woodcock-delta tracking.


\section{Hybrid Delta Tracking Schemes}

In this section we introduce and verify the voxilized tally structure that allows MC/DC to use a track length estimator while Woodcock-delta sampling.
We also introduce two hybrid surface-delta tracking schemes we implement in time-dependent transport with moving surfaces in MC/DC.
The first is a region-based delta tracking method we call \emph{hybrid-in-material} that has been implemented before in other production Monte Carlo neutron transport applications \cite{fang_development_2022, leppanen_development_2013}.
The second and novel method uses delta tracking in high energies above neutron cross-section resonances, where total cross sections are often similar to the majorant, and track lengths are long relative to nominal system dimensions which we call \emph{hybrid-in-energy}.


\subsection{Voxelized Tallies}
\label{sec:voxtallies}

Traditional Woodcock-delta tracking algorithms do not keep track of what material or physical mesh cell a given particle occupies at any moment in transport.
Conventional wisdom dictates that repeatedly conducting lookups of locations, cross sections, and tally bin indices while Woodcock delta tracking would be prohibitively costly and eliminate any benefit to performance the method provides.
It follows that Woodcock-delta tracking precludes use of a track length estimator for quantities of interest.
Crucially there is nothing \textit{mathematically} preventing the use of a track length estimator with Woodcock-delta tracking, only engineering issues.
Furthermore, if all that is needed to quantify a given problem is the total scalar flux, no such extra cross section lookups are needed---only an identifying the track length and bin to accumulate.
This forms the underlying assumptions that are used in this work.
Weather or not this benefits performance is an open question.

\begin{figure}[!htb]
  \centering
  \includegraphics[width=\textwidth]{figures/delta_figs/tally_ray.pdf}
  \caption{A particle tallying to multiple tally mesh bins (shown in red). Implemented as a single operation for both surface and Woodcock-delta tracking in MC/DC.}
  \label{fig:tally_ray}
\end{figure}

As of v0.11.1, MC/DC \cite{morgan_monte_2024} has a tally algorithm where track lengths to multiple structured mesh tally bins (which we call voxels\footnote{\textit{voxel} is the 3D analog to a pixel, here we mean it as a cube mesh bin to tally into.}
) are scored in a single operation.
This algorithm is based on a sweeping method where the initial state (mesh cell index, exact ($x$, $y$, $z$) position, direction of travel, speed, and particle clock) is known, as is the distance to the next event.
The particle is then swept from tally voxel to tally voxel, accumulating the exact track length traveled in a given voxel along the way.
Figure \ref{fig:tally_ray} shows a hypothetical particle track and the voxels to be tallied to (in red) in a single operation.
In MC/DC's normal algorithm this is done even before moving a particle to an event while surface tracking.
Crucially a voxel indicates that we are tallying to a structured rectilinear mesh bin.

In this work, we use this voxelized tally scheme when undergoing Woodcock-delta tracking.
Even if a particle collision is rejected, that particle still physically moves to the location that was sampled, allowing the use of the track length estimator.
In this scheme the distance tallied is always the distance sampled with the majorant, barring census crossings or distance to boundary events.
We expect this voxelized tally method to support getting a less variant tally in problems with void regions where a collision estimator (adapted or otherwise) will not preform efficiently.

To verify that MC/DC's voxelized track length tallies with delta tracking both converges to the correct solution and at the correct rate, we use four anaclitic fixed-source benchmark problems from MC/DC's verification suite.
We compare the error (by both $L_\infty$ and $L_2$ norms) from integral quantities of interest to a reference solution then plot the error as a function of increasing particle count.
The convergence rate should be the standard Monte Carlo convergence rate of $N^{-1/2}$.
Our verification problems are:
\begin{itemize}
    \item AZURV1 time-dependent benchmark both super and sub critical (Figure \ref{fig:azurv1}) \cite{ganapol_homogeneous_2001};
    \item A time-dependent infinite pin cell using the 371 group SHEM cross sections (Figure \ref{fig:shem}) \cite{hfaiedh_2005_shem}; 
    \item Reed's problem (Figure \ref{fig:reeds}) \cite{reed_difference_1971}; and
    \item A purely absorbing 3-region slab (Figure \ref{fig:abs_slab}).
\end{itemize}
\begin{figure}
  \centering
  \includegraphics[width=0.32\linewidth]{figures/delta_figs/verification/azurv1/azurv1_flux.png}
  \includegraphics[width=0.32\linewidth]{figures/delta_figs/verification/azurv1/azurv1_census_flux.png}
  \includegraphics[width=0.32\linewidth]{figures/delta_figs/verification/azurv1/azurv1_census_tally_flux.png}
  \includegraphics[width=0.32\linewidth]{figures/delta_figs/verification/azurv1/azurv1_sub_flux.png}
  \includegraphics[width=0.32\linewidth]{figures/delta_figs/verification/azurv1/azurv1_super_flux.png}
  \caption{Convergence rate verification of AZURV1 \cite{ganapol_homogeneous_2001}, showing the expect Monte Carlo convergence rate ($N^{-1/2}$)}
  \label{fig:azurv1}
\end{figure}
\begin{figure}
  \centering
  \includegraphics[width=0.32\linewidth]{figures/delta_figs/verification/shem/inf_shem361_flux.png}
  \includegraphics[width=0.32\linewidth]{figures/delta_figs/verification/shem/inf_shem361_td_n.png}
  \includegraphics[width=0.32\linewidth]{figures/delta_figs/verification/shem/inf_shem361_td_census_n.png}
  \includegraphics[width=0.32\linewidth]{figures/delta_figs/verification/shem/inf_shem361_td_flux.png}
  \includegraphics[width=0.32\linewidth]{figures/delta_figs/verification/shem/inf_shem361_td_census_flux.png}
  \caption{Convergence rate of an infinite pin using the SHEM 361 group cross section library \cite{hfaiedh_2005_shem}, showing the expect Monte Carlo convergence rate ($N^{-1/2}$)}
  \label{fig:shem}
\end{figure}
\begin{figure}
  \centering
  \includegraphics[scale=0.75]{figures/delta_figs/verification/reed/reed_flux.png}
  \caption{Convergence rate of flux from Reed's problem \cite{reed_difference_1971}}
  \label{fig:reeds}
\end{figure}
\begin{figure}
    \centering
    \includegraphics[width=0.75\linewidth]{figures/delta_figs/verification/abs_slab/slab_absorbium_flux.png}
    \caption{Convergence rate of QOIs for a purely absorbing slab wall problem, showing the expect Monte Carlo convergence rate ($N^{-1/2}$)}
    \label{fig:abs_slab}
\end{figure}

All verification simulations show the $N^{-1/2}$ convergence rate expected for Monte Carlo results.
This verifies that we get the expected results with voxelized Woodcock-delta tracking.


\subsection{Hybrid-in-material}
\label{sec:material_exc}


The first hybrid method we implement in MC/DC is a material- or region-based decision on whether to surface or delta track, we call ``hybrid-in-material".
Each particle is given an additional flag declaring which transport algorithm it is using to sample a distance to next event.
At the beginning of the \texttt{determine\_next\_event()} function the tracking flag will be set to \texttt{true} if the particle is in a material region declared by the user to undergo delta tracking or \texttt{false} if in a region where delta tracking should not be used. 
This is similar to Serpent2's algorithm \cite{leppanen_use_2017}; however, our voxelized tally structure allows us to use track length estimators in all regions not just those undergoing surface tracking.
Also, Serpent2's algorithm makes automatic decisions about where to surface and delta track based on a user-supplied cut-off value \cite{leppanen_development_2013}, whereas we leave it as user option for now.
The IMPC Monte Carlo neutron transport code also implements a similar hybrid-in-material surface-delta tracking scheme \cite{fang_development_2022}.


\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{figures/delta_figs/macro_majorant_dragon.pdf}
    \caption{Continuous energy macroscopic majorant ($\maj$) and other material cross-sections for the Dragon burst problem.}
    \label{fig:majorant_dragon}
\end{figure}

Conventional wisdom dictates that delta tracking should not be used in systems with strong localized absorbers as the majorant will be governed by cross sections much larger than others in the system.
Figure \ref{fig:majorant_dragon} shows the cross section information for the Dragon burst problem we describe in Section \ref{sec:benchmarks}.
This is a simulation that does not warrant Woodcock-delta tracking.
This simulation contains three materials, two of which (the fuel and tamper) have similar cross sections over all energies clumped together.
However, the cross sections modeling air are over four orders of magnitude lower then the cross-sections modeling the fuel and tamper materials.
This means that while particles are delta tracking in the air, they will get stuck in the rejection sampling loop, statistically rarely completing a particle history.
Furthermore, for Traditional Woodcock delta tracking (where only a collision estimator can be used) the tallies in the air will be highly variant as there will be statistically few collisions taking place.
Using surface tracking in the air and delta tracking in the material may improve performance in this problem.

\subsection{Hybrid-In-Energy}
\label{sec:cutoff}

The second hybrid method we call ``hybrid-in-energy", and is a decision to delta track above a given energy and surface track below.
For neutrons, high energies (or speeds) are characterized by relatively long mean free paths (small cross sections) as they are physically going too fast to interact with anything.
Delta tracking compared to surface tracking generally does better under these conditions, because surface tracking would get stuck moving particles from region to region.
Delta tracking on the other-hand will stream particles through the whole problem never conducting expensive distance to nearest surface computations.
Furthermore, at higher energies, in many systems the majorant will more-closely match the cross sections of all materials, alleviating issues with the rejection sampling loop.

For example, consider a continuous energy version of the C5G7 benchmark reactor geometry \cite{jia_hou_oecdnea_2017}.
The material composition is given by Table \ref{tab:c5ce} in Appendix \ref{app:c5ce_mat}.
Figure \ref{fig:majorant_c5ce} shows the macroscopic material cross-sections for the seven material reactor, with the majorant in black.
Around \SI{10}{\kilo\electronvolt} the neutron resonances end and the problem can be considered ``high energy". 

If using delta tracking for this whole problem, neutrons will get stuck in resonance frequencies where the rejection sampling loop will be called too often---degrading the performance of delta tracking.
Therefore it would be ideal to delta track above \SI{50}{\kilo\electronvolt} (as to completely avoid neutron resonances) and surface track under that threshold.

\subsection{Implementation in MC/DC}
\label{sec:implementation}

Monte Carlo Dynamic Code is purpose built to implement and test novel time-dependent Monte Carlo numerical methods at scale \cite{morgan_2025_monte, morgan_monte_2024}.
It uses a novel (for the field) development structure where Python compute kernels are compiled via the Numba compiler to run on CPUs and with the Harmonize runtime manager \cite{brax2023, cuneo_2025_harmonize} to run on GPUs.
MC/DC allows us to rapidly experiment with these methods at scale on both CPUs and GPUs with time-dependent problems of interest.

Generally, to implement delta tracking in a code that already implements surface tracking, the operations needed are:
\begin{enumerate}
    \item Pre-process functions to generate a majorant (MC/DC's implementation is in Appendix \ref{app:majorant});
    \item Add \texttt{if} statements in \texttt{distance\_to\_next\_event()} functions to compute relevant distances;
    \item Functions to implement boundary conditions when in delta tracking mode; and
    \item Elevate delta tracking options to the input deck.
\end{enumerate}
This process was similar to implementing hybrid surface-delta tracking methods in MCATK \cite{morgan2023delta}.
However, previous work in MCATK implemented only a single delta tracking algorithm, which was conceived in-part to integrate into MCATK smoothly.
Notably, full Woodcock-delta tracking was not implemented in MCATK.

In this work we implement full Woodcock delta tracking, Woodcock-delta tracking using voxelized tallies and two hybrid delta-surface tracking algorithms in MC/DC.
Our implementation in total added about \num{450} lines of code, of which half was to produce various types of majorants (an example can be found in Appendix \ref{app:majorant}). 
Only about \num{200} lines of code were required in compute kernels to implement all considered methods.

%This is also similar to current ongoing work in OpenMC.

We found the most complicated issue when implementing traditional Woodcock delta tracking in MC/DC was handling boundary conditions.
Surface tracking codes (like MC/DC) often contain boundary condition flags for all surfaces which will be flipped to \texttt{True} for boundary surfaces.
When Woodcock delta tracking we will not be able to use this information.

Vacuum boundary conditions are simple, as if a particle is determined to be out of the problem domain when looking for a cross section during the rejection sample, particles are terminated.
For reflecting surfaces we use a stripped down version of the \texttt{distance\_to\_nearest\\\_surface} function in MCDC to compute distances to reflecting surfaces only, if any exist in a given problem.
Many reflecting boundary conditions, including the ones we implement in our benchmark problems, are imposed on planar surfaces, making these specific distance to boundary computations cheap.
In effect we are still surface tracking---only to our reflecting boundary surfaces.

\section{Verification of Woodcock-delta tracking with continuously moving surfaces}

To verify that Woodcock-delta tracking can be used in conjunction with the continuously moving surfaces in MC/DC, we use the moving pellet regression test from MC/DC's regression test suite \cite{morgan_monte_2024}, where a cylindrical fuel element moves through a region which also has a small source.
As the pellet moves closer and farther from the source region the fission rate in the pellet changes.
Figure \ref{fig:moving_pellet} at left shows the fission reaction rate density at various points in time.
The outline of the pellet can be seen clearly in a number of time steps.
These plots were produced using Woodcock-delta tracking with a collision estimator (as to get fission reaction rates) and match plots produced when using surface tracking with a collision estimator.

\begin{figure}
    \centering
    \includegraphics[width=.75\linewidth]{figures/delta_figs/verification/moving_pellet_plot.pdf}
    \vspace{1em}
    \includegraphics[width=.75\linewidth]{figures/delta_figs/verification/moving_pellet.pdf}
    \caption{(top) Fission flux density at various points in time for the moving pellet problem, using Woodcock-delta tracking with a collision estimator (bottom) convergence between fluxes produced from surface and Woodcock-delta tracking both with the track length estimator, showing $N^{-1/2}$ convergence rate.}
    \label{fig:moving_pellet}
\end{figure}

To further verify Woodcock-delta tracking may be used with continuous movement physics we regressively compare the scalar flux solutions provided from traditional surface tracking and Woodcock delta tracking with voxelized tallies at various particle counts.
We compute 
\begin{equation}
    \epsilon_N = \left|\left|\phi_N^{\text{surface}} - \phi_N^{\text{delta}} \right|\right|_2
\end{equation}
at every choice of $N$ particles.
We then compare the error of flux over particles to ensure the expected Monte Carlo convergence rate ($N^{-0.5}$).
Figure \ref{fig:moving_pellet} at right shows the error converging at the expected rate.
This regressively verifies that Woodcock-delta tracking can be used in conjunction with continuously moving surfaces.
We also produced this same plot for both tracking method using a collision estimator for both flux and fission tallies, all of which match the expected Monte Carlo convergence rate.

\section{Benchmark Problems}
\label{sec:benchmarks}

% vairiance reudciton and figure of merrit
The performance of a given Monte Carlo algorithm for a specified problem is a function of solver variance ($\sigma^2$, from the Monte Carlo process itself) and the wall-clock runtime it takes to get that solution.
If a certain algorithm can form a low variant solution with fewer particles, as compared to another algorithm, it may still not increase solver efficiency if it takes too long to get that solution.
A comparative measurement must be used to take into account both the variance and computation time of a given solution.
Figure of merit (FOM) is one such measure. In this work we will use 
\begin{equation}
    FOM = \frac{1}{\hat{\sigma}^2 t_{wc}} \; ,
\end{equation}
where $\hat{\sigma}^2$ is the L$_{1}$ norm (over phase space) of the variance of the solution provided by the Monte Carlo solver and $t_{wc}$ is the measured wall-clock runtime the solver took to compute that solution.

% the problems we run themselves
We use four fully time-dependent fixed-source benchmark problems to compare the voxelized tally scheme and hybrid methods proposed in this work to surface tracking methods on CPU and GPU machines.
Two problems are multi-group, and two are continuous energy.
Table \ref{table:benchmark_problems} summarizes the size (in both mesh and particle count) of each benchmark problem.
Some problems may not be suited for Woodcock delta tracking methods but are used here to show both correctness under physical problem dynamics (e.g., moving surface) and demonstrate algorithmic performance in under highly exaggerated problem parameters.
We run and compare all simulations with at lest four algorithms: surface tracking with a track length and collision estimator, as well as Woodcock-delta tracking with both a collision and track length estimator.
For two models we add two additional runs with a hybrid delta-surface tracking algorithm using either a collision or track length tally.

\begin{table}
  \centering
  \begin{tabular}{@{}l c c c @{}} \toprule
    Problem & $N_{\text{mesh}}$ & $N_{\text{particles}}$ & Energy physics \\ \midrule
    Kobayashi & \num{1.20e5} & \num{1e10} & MG (1 group) \\
    Dragon Burst & \num{4.0e6} & \num{3e9} & Cont. E (3 materials) \\
    C5G7 & \num{3.9e6} & \num{1e7} & MG (7 groups) \\
    C5CE & \num{5.44e5} & \num{1e5} & Cont. E (7 materials) \\
    \bottomrule
  \end{tabular}
  \caption{time-dependent benchmark problems.} 
  \label{table:benchmark_problems} 
\end{table}

% koby intro
The first benchmark we consider is the time-dependent version of the Kobayashi problem \cite{Kobayashi2001} introduced by Variansyah, et al. \cite{variansyah_mc23_mcdc}.
We run this problem in 10 batches with \num{1e9} particles per batch (\num{1e10} particles total) with surface tracking, traditional delta tracking with a collision estimator, and a delta tracking using the voxelized tally method.
This problem contains two materials, a dense region (characterizing a solid), and a low density region modeled by air (characterizing a void) in a single energy group.
There are a \num{1.20e5} structured tally voxels in the $x$-$y$ plane and in time.
This is a problem we expect the voxelized tally method to perform better then traditional Woodcock-delta tracking and surface tracking.

\begin{figure}
    \centering
    \includegraphics[width=0.48\linewidth]{figures/delta_figs/dragon.png}
    \includegraphics[width=0.48\linewidth]{figures/delta_figs/c5g7.png}
    \caption{Schematics (left) Dragon burst problem \cite{kimpland2021dragon} (right) C5G7 reactor quarter (via reflecting boundaries) \cite{jia_hou_oecdnea_2017}}
    \label{fig:schems}
\end{figure}

% acident intro
Figure \ref{fig:schems} at right shows the geometry for the next two simulations we consider based on the C5G7 benchmark problem \cite{jia_hou_oecdnea_2017}.
We model a four-phase accident where a pressurized light water reactor is powering up by removing control rods.
Figure \ref{fig:c5g7} at left shows the normalized flux density as a function of time (produced from reactor point kinetics) and the four-phases shaded as gray, green, red, and blue respectively.
Phase one (shaded gray) starts with the reactor operating at steady state.
In phase two (shaded green) the control rods are removed from the reactor to power up to a new (higher power) steady state.
Phase three (shaded red) begins when a bank of control rods gets stuck in the fully withdrawn position.
Towards the end of phase three the reactor sees a rapid spike in power that ends at \SI{15}{\s} when all the control rods are forced into the reactor ending the accident.
The fourth and final phase sees the reactor decaying in power as the delayed neutron population dies out.
Figure \ref{fig:c5g7} shows plots of average flux in the $x$-$y$ plane at various points in time including at \SI{14.95}{\s}, the maximum power excursion.
These results are produced from running \num{1e6} particles in \num{10} batches (total of \num{1e7} particles).

\begin{figure}
    \centering
    \includegraphics[width=.7\linewidth]{figures/delta_figs/c5/acc.pdf}
    \vspace{2em}
    \includegraphics[width=.75\linewidth]{figures/delta_figs/c5/flux.pdf}
    \caption{C5G7 stuck rod accident simulation, (top) flux densities through time showing the four-phases shaded as gray, green, red, and blue respectively (bottom) scalar flux on $x$-$y$  plane (top view) at points in time}
    \label{fig:c5g7}
\end{figure}

We first model this problem using the seven group materials described by the normal C5G7 benchmark \cite{jia_hou_oecdnea_2017} which we call C5G7 in the remainder of this work.
We model C5G7 with \num{3.9} million mesh cells in a full 3D, time and energy dependent tally mesh.
The movement of the control rods into and out of the reactor is controlled with MC/DC's continuous movement functionality \cite{variansyah_2023_highfidelity}.
To verify that the delta tracking methods we explore converge to the correct solutions using continuously moving surfaces we compare delta tracking solutions to solutions provided by surface tracking.
This further verifies that Woodcock delta tracking can be used in conjunction with continuously moving surfaces.
Performance data is collected by running \num{1e6} particles in \num{10} batches (total of \num{1e7} particles).

Next, we define a continuous energy version of the C5G7 geometry, we call C5CE, undergoing the same four-phase accident.
Table \ref{tab:c5ce} in Appendix \ref{app:c5ce_mat} shows material compositions for the C5CE problem.
Using this benchmark we evaluate both the voxelized tally method as well as the hybrid-in-energy method described in Section \ref{sec:cutoff}.
Figure \ref{fig:majorant_c5ce} plots the macroscopic total and majorant cross sections over energy for the materials in C5CE.
The neutron resonances end around \SI{10}{\kilo\electronvolt}, so we set a cut off at \SI{50}{\kilo\electronvolt}.
Particles moving at speeds above \SI{50}{\kilo\electronvolt} will use Woodcock-delta tracking and below will use traditional surface tracking.

We expect this to provide significant speedup over all previous methods explored in this problem as we avoid negative impacts of either tracking method; surface tracking moving from surface to surface and Woodcock-delta tracking getting stuck in the rejection sample. 
C5CE also includes the same continuously moving surfaces as C5G7 so it serves as an additional verification that delta tracking methods can be used in conjunction with continuously moving surfaces.
We model this problem with \num{544e3} mesh tally bins in 2D $x$-$y$ geometry (integrated along $z$), time, and energy dependent tally mesh.
We run \num{1e5} particles in a single batch.

% dragon intro
The next problem we consider is a full time-dependent simulation of the historical Dragon-burst experiments \cite{kimpland2021dragon}.
Conducted in 1944 during the Manhattan project, it proved that criticality could be achieved with prompt neutrons only.
Previous experiments, like the Chicago Pile One, used delayed neutrons to achieve criticality.
Figure \ref{fig:schems} at left shows a schematic of the experiment where a slug of highly enriched (75\%) Uranium Hydride (UH$_{10}$) was doped through a tamper with additional fuel.
The slug moves through the core triggering a prompt critical reaction as critical mass was achieved.
Before the super-critical burst could become a problem (i.e., a deadly uncontrollable blast), gravity would pull the slug out of the core, ending the reaction.
Kimpland et al.~ showed that this burst criticality experiment could achieve over nine orders of burst magnitude \cite{kimpland2021dragon}.
Work is on going to model the problem up to nine orders of burst magnitude in MC/DC~\cite{variansyah_2025_dragon} but in this work we use a less reactive version (25\% enrichment) to test delta tracking with the hybrid-in-material method described in Section \ref{sec:material_exc} and to provide additional verification for delta tracking with continuously moving surfaces.
Figure \ref{fig:dragon_results} shows the overall flux density through time at left and a y-z plot of scalar flux at various points in time on the right.

\begin{figure}
    \centering
    \includegraphics[width=.75\linewidth]{figures/delta_figs/dragon/dragon_curve.pdf}
    \vspace{1em}
    \includegraphics[width=.75\linewidth]{figures/delta_figs/dragon/flux_dragon.pdf}
    \caption{Dragon burst simulation, (top) flux density through time, (bottom) scalar flux on y-z plane (side view) at points in time.}
    \label{fig:dragon_results}
\end{figure}

Figure \ref{fig:majorant_dragon} at left shows the continuous energy macroscopic total cross sections in the model we simulate.
The majorant, tamper, and fuel cross sections all lie almost four orders magnitude above the cross section for air.
This is due to air being low density, meaning fewer atoms to the interact with neutrons.
We expect any Woodcock-delta tracking algorithm to perform quite poorly in this model for a number of reasons.
First, when undergoing delta tracking particles in the air region will get stuck in the rejection sample loop for a long time, as the majorant is orders of magnitude larger and will sample small distances before conducting a rejection sample.
Second, as much of the problem is a void region, the collision estimator that normal delta tracking requires will provide poor tallies in those regions.0
Third, the problem is geometrically simple, consisting of a rectangular slug moving through a rectangular slab with a complimentary hole.
Traditional wisdom suggests that delta tracking performs best in geometrically complex models \cite{woodcock_techniques_1965}.
The point of comparing delta tracking methods for this specific problem is to first confirm that delta tracking works with such a dynamic problem with continuously moving materials and seconded observe if any performance increases with respect the performance to standard Woodcock-delta tracking when using the hybrid-in-material method.

\section{Results}

\input{figures/delta_figs/results_tab}

In this section we discuss performance results of the benchmarks described above with surface, traditional delta, voxelized delta tracking as well as the hybrid-in-energy and hybrid-in-material tracking algorithms.
We also verify that the various delta tracking methods converge to the same solution as surface tracking while transporting on a geometry with continuously moving surfaces.

\subsection{Performance results}

% testing systems
Our benchmark simulations are executed on high-performance computing systems from Lawrence Livermore National Laboratory (LLNL): the Dane and Lassen machines.
Dane is a CPU-only system with dual-socket Intel Xeon Sapphire Rapids CPUs, each with 56 cores for a total of 112 CPU cores per node. 
Lassen is the open collaboration sibling to the Sierra machine with four Nvidia Tesla V100 GPUs and two IBM Power 9 CPUs per node.
We will make all performance statements with respect to a whole node of Dane (112 MPI threads, CPU) and a whole node of Lassen (4 MPI Threads, GPU).
We compile to CPUs with Numba v0.60.0.
We compile to Nvidia GPUs with CUDA v11.8 and Nvida-PTX with Numba v0.59.0\footnote{Numba v0.59.1 is the most recent version to support Power9 CPUs.}.
We build our delta tracking methods using MC/DC v0.12.0 \cite{transport_cement_mcdc_2024} and compile on GPUs with Harmonize v0.0.2 \cite{harmonize}.
We use double precision for all floating-point operations.
% Introduce the table
Table \ref{tab:dane_results} and \ref{tab:lassen_results} show the wall-clock runtimes, normalized standard deviations, and figures of merit for benchmark problems using various transport algorithms and flux estimators on the Dane and Lassen machines, respectively.

% Results Koby
The Kobayashi problem on Dane sees dramatic runtime improvements when moving from surface with a collision or track length estimator to delta tracking with a collision estimator.
However, this does not make up for the two orders of magnitude additional variance on the tallies of interest incurred by the collision estimator.
This leads to a dramatically smaller figure of merit for traditional delta tracking and surface tracking (using a collision estimator) compared to modes using a track length estimator.
Figure \ref{fig:koby} shows the simulated flux at various points in time for the Kobayashi problem computing using traditional delta tracking with a collision estimator on the bottom and our voxelized delta tracking on top.
The collision estimator is produces a solution with higher variance (appearing as static, snow, or fuzz) result than the track length estimator.
Our voxelized tally method sees a 21\% decrease in wall-clock time compared with the same amount of normalized variance, leading to a moderately improved figure of merit (\num{0.1697} and \num{0.1407} for our voxelized method and surface tracking, respectively).
On GPUs the pattern is the same with the voxelized method performing slightly better then surface tracking with a track length estimator.
All algorithms see between a 1.2$\times$ and 1.7$\times$ speedup when running on Lassen versus Dane. 

%This pattern of results, where traditional delta tracking is the fastest wall-clock runtime with a normalized variance orders of magnitude above methods using a track length estimator, will persist through the analysis of the other problems we consider.
%As will the behavior of the voxelized delta method's runtime sitting between surface tracking and traditional delta tracking with similar variance to surface tracking results.


\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{figures/delta_figs/cle_v_tle.pdf}
    \caption{Comparison of Woodcock-delta tracking using the track length estimator (top row) and collision estimator (bottom row) at three points in time. The solution produced with  the collision estimator has a much higher variance.}
    \label{fig:koby}
\end{figure}

% Restuls C5G7
For C5G7 on Dane, traditional delta tracking performs the best with similar errors (\SI{1673}{\s} and \num{1.400e-4}, respectively), while surface tracking sees the longest runtime and voxelized delta tracking sits between the two (\SI{7920}{\s} and \SI{2870}{\s}, respectively) with roughly the same error (~\num{1e-4}).
For C5G7 there does not seem to be a benefit in using the track length estimator.
The pattern continues on Lassen, with between \num{1.7}$\times$ and \num{2}$\times$ wall-clock runtime speedup for all tracking methods when moving from Dane to Lassen while variance remains about the same.
Voxelized delta tracking shows a \num{2.6}$\times$ and \num{2.7}$\times$ higher figure of merit over surface tracking on Dane and Lassen, respectively.
While traditional Woodcock-delta tracking performs slightly better then the voxelized tally method.

% Restuls C5CE
The C5CE problem shows that surface tracking methods measured the highest FOMs, either with a collision or track length estimator.
The speedup of Lassen over Dane is now lower (between \num{0.9}$\times$ and \num{1.3}$\times$) indicating improvements are needed for our continuous energy physics when implemented on GPU.
The hybrid-in-energy method provided significant improvement of figure of merit with an order of magnitude increase (\num{11}$\times$ on Dane, \num{7}$\times$ on Lassen) 
The use of the collision estimator in the hybrid method slightly outperformed the use of the track length estimator.

% Restuls Dragon
The performance of the Dragon problem is an outlier in the behavior of the methods we consider.
Delta tracking (both traditional and voxelized) do not finish on Dane or Lassen in the 8 hours given to complete the simulation on either machine.
On Dane as predicted the hybrid-in-material method does improve over the other two methods, as it completes the simulation in about four hours while traditional surface tracking completes it in one.
The hybrid-in-material method did not finish on Lassen.
Also, as predicted, this is a problem that does not warrant any delta tracking methods due to the material composition and geometric layout of the problem.


\section{Discussion, Conclusions, and Future Work}
\label{disucssions}

We have implemented Woodcock-delta tracking in MC/DC on CPUs and GPUs including using a voxelized track length tally to efficiently score scalar flux.
We verify the solution produced by this method against various steady state and time-dependent analytic benchmark problems available in MC/DC's verification suite.
We have also verified that Woodcock-delta tracking functions properly with continuously moving surfaces in MC/DC using the fuel pellet problem.
Figures of merit improve modestly in large scale multi-group and continuous energy time-dependent benchmark problems when using this tracking and tallying technique on CPUs and GPUs.

We have also demonstrated a novel hybrid surface-delta tracking scheme called hybrid-in-energy where surface and delta tracking are used at low and high energies, respectively.
For a continuous energy version of the C5G7 benchmark geometry undergoing a four-phase transient, we observe an order of magnitude increase in figure of merit when executing on both CPU and GPU nodes.
We have also confirmed that the hybrid surface-delta tracking methods can yield improved results in problems with significant void regions \cite{leppanen_2010_burnup}.

An efficient Monte Carlo algorithm is a combination of a numerical method getting a lower variance with fewer particles and an efficient implementation of that numerical method.
What makes a given delta or a given surface tracking algorithm more or less ``efficient" than the other can vary code-to-code depending on what optimizations a developers of a software have made.
Not every code implements tallying the way MC/DC does meaning the added efficiency of using the voxelized tally may not be viable option in other Monte Carlo neutron transport codes.

The major take away of this work is that Woodcock delta and surface tracking do not have to be treated as discrete choices in numerical method.
This matches what the developers of Serpent2, and MONK/MCBEND have known for years \cite{leppanen_use_2017, richards_monk_2015}.
Greater performance can be achieved by mixing and matching the underlying transport methods given the detectable physics of a simulation and the relative strengths and weakness of a given transport application.
As we discussed in Section \ref{sec:implementation} taking a surface transport code and implementing delta tracking is simple given a method of computing a macroscopic majorant cross section.
This process has been completed at least twice now in MCATK \cite{morgan2023delta}, and MC/DC with work ongoing in OpenMC and MCNP. % cite their branch

For the voxelized tally method in void regions this work is promising, but the lack of non-integral tallies means limited applicability to physical problems of interest.
Work is on-going in producing efficient methods of computing relevant macroscopic cross-sections defined on a structured mesh while a particle is undergoing transport.
This process is simple for multi-group cross-sections where reaction rates can be determined entirely as a post process but work is ongoing to identify the most efficient method for continuous energy transport.

A method of reducing the dimensionality of the majorant is also under active research in order to have a smaller more efficient majorant cross section lookup in the sample distance to collision operations.
Implementing post process reaction tallies for other quantities of interest is also ongoing.
Experiments with the collision flux estimator and methods of tallying into vacuum and low interaction rate regions are being considered including implementing the cutoff method \cite{leppanen_2010_burnup} or weighted delta tracking \cite{morgan_weighted-delta-tracking_2015}.
%Research is also ongoing into methods to tally with multiple estimators .
%If only one estimator is used at a time then we avoid the need for complex covariance computations (e.g., those implemented in MCNP \cite{urbatsch_estimation_1995, MCNP_RisingArmstrongEtAl}).

%Combinations of the Woodcock-delta and surface tracking algorithms proves to be a compiling field of research in Monte Carlo neutron transport.
%The combination of these two tracking algorithms allows for greater performance adaptability on a broader set of problem physics where one scheme may out perform another.
%Either method is a valid sampling of the cumulative probability distribution function at any point in transport.
%Modest to significant improvements may occur when taking advantage of that fact.


\section*{Acknowledgments}
We thank Patrick Shriwise and Paul Romano of Argonne National Laboratory, Mike Rising of Los Alamos National Laboratory, Jaakko Leppänen of VTT Technical Research Center of Finland, and Simon Richards of ANSWERS software for productive conversations.
We also thank the high performance computing staff at Lawrence Livermore National Laboratory for continued support using the Dane machine. 

This work was supported by the Center for Exascale Monte-Carlo Neutron Transport (CEMeNT) a PSAAP-III project funded by the Department of Energy, grant number: DE-NA003967.

\section*{Appendix}

\subsection*{Continuous Energy Macroscopic Majorant}
\label{app:majorant}

To compute a unified energy grid per material we combine the energy grids from all nuclides in a given material. 
Then, we call \texttt{numpy.unique()} which returns a sorted array (form smallest to largest) with no repeating elements \cite{van_der_walt_numpy_2011}.
To compute a unified energy grid for the whole problem we do the same but with all the nuclides in the entire problem.

Computing a macroscopic majorant for nuclides that are not on a unified energy grid requires two levels of interpolation to put a given macroscopic total cross section on a unified energy grid.
First, interpolate from each nuclide's microscopic cross section onto a materials unified energy grid to compute a macroscopic total cross section.
Then, interpolate again from the material to the majorant's unified energy grid.
We use \texttt{scipy.interpolate.interp1d()} to interpolate from one energy grid to the next \cite{2020SciPy-NMeth:a}. 

The following code shows how this is done in MC/DC:

\input{figures/delta_figs/majorant_alg}

This process results in a quite unwieldy majorant cross section.
More efficient algorithms exist to produce an accurate majorant with fewer points.
Delta tracking codes like Serpent2, GARDYUN, and IMPC avoid the need for energy grid unification by having all nuclides on a unified energy grid in their data libraries \cite{leppanen_2010_burnup, molnar_gpu_based_2019, fang_development_2022}.


\newpage

\subsection*{Appendix: C5CE Material Definition}
\label{app:c5ce_mat}
\input{figures/delta_figs/c5ce_tab}